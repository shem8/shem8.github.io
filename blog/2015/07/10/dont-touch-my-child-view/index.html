
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Don't touch my child (view)! - 80/20</title>
	<meta name="author" content="Shem Magnezi">

	
	<meta name="description" content="Don't Touch My Child (View)! A few days ago I’ve struggling with some bug someone reported about one my apps- ripples. A little background about the &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="80/20" type="application/atom+xml">
	
	<link rel="canonical" href="http://shem8.github.io/blog/2015/07/10/dont-touch-my-child-view/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-78073130-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("smagnezi8@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><ul class="main">
    <li><a href="/">Blog</a></li>
    <li><a href="/about">About</a></li>
    <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:smagnezi8@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/shemag8" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/shem8" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Don't Touch My Child (View)!</h1>
	<div class="entry-content" itemprop="articleBody"><p>A few days ago I’ve struggling with some bug someone reported about one my apps- <a href="https://play.google.com/store/apps/details?id=shem.getit">ripples</a>.</p>

<!--more-->


<p>A little background about the app- it’s an interactive game where ripples appear randomly on the screen and the user need to pop them out by touching them for couple of seconds.</p>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*jxjAMG3FfKvvnb4KY5r14w.gif" alt="" />The bug was happen when we touch first the parent view and then the ripple view. As you can see in the example above, the user touch the background and then when the ripple appear and the user try to touch it- touch events on the ripple view are disabled.</p>

<p>In a game like this, where interactions are critical part of the game, it’s a must-fix bug.</p>

<p>BTW- multi-touch is supported in the game, if you touch in the same view or touch 2 ripples views, it works fine. Problem start happen only when the parent view is getting on the touches.</p>

<hr />

<h4>So let’s start diving into the problem</h4>

<p>First- let’s get to know the views we’re handling with and the key methods we need to know when handling with touch events.</p>

<p>The parent view is just simple RelativeLayout that wasn’t changed in any way:</p>

<pre><code>public class &lt;strong class="markup--strong markup--pre-strong"&gt;MyRelativeLayout&lt;/strong&gt; extends &lt;strong class="markup--strong markup--pre-strong"&gt;RelativeLayout&lt;/strong&gt; {&lt;em class="markup--em markup--pre-em"&gt;
  //Nothing here for now.
&lt;/em&gt;}
</code></pre>

<p>The ripple view is a little more complicated but for simplicity I stripped out all the unrelated code:</p>

<pre><code>public class &lt;strong class="markup--strong markup--pre-strong"&gt;RippleGameView&lt;/strong&gt; extends &lt;strong class="markup--strong markup--pre-strong"&gt;FrameLayout&lt;/strong&gt; {
  @Override
  public boolean &lt;strong class="markup--strong markup--pre-strong"&gt;onTouchEvent&lt;/strong&gt;(MotionEvent event) {
&lt;em class="markup--em markup--pre-em"&gt;    //Handle the user touches according to the game state&lt;/em&gt;
  }
}
</code></pre>

<p>The problem is that the <strong>onTouchEvent </strong>in the child view not called when touches happen in the parent view, the one that responsible for calling <strong>onTouchEvent </strong>is <strong>dispatchTouchEvent </strong>in the parent view.</p>

<p>A quick look on the dispatchTouchEvent method in the RelativeLayout source code (the implementation is actually in the GroupView) gonna show us a really-terrifying-long-and-generic-code-for-all-states (But we can still learn from it a lot, and I recommend you to read as much code of the android platform as possible). The code actually contains handling touch in sub-views and check their states and visibility, it contains some listeners and handling sequences of touches, it checking again list of touches it has and update them.</p>

<h4>Bottom line- this code doing a lots of things that we <strong><em>know</em></strong> that is unnecessary in our case.</h4>

<p>That’s why we can implement our own version that’s gonna act like we wanted, it’s suppose to be something like this:</p>

<pre><code>@Override
public boolean &lt;strong class="markup--strong markup--pre-strong"&gt;dispatchTouchEvent&lt;/strong&gt;(MotionEvent ev) {
&lt;em class="markup--em markup--pre-em"&gt;    //Get the touch position&lt;/em&gt;
    int actionIndex = ev.getActionIndex();
    final float x = ev.getX(actionIndex);
    final float y = ev.getY(actionIndex);

&lt;em class="markup--em markup--pre-em"&gt;    //Iterate over child view and search for the right child that should handle this touch event&lt;/em&gt;
    for (int i = getChildCount() - 1; i &gt;= 0; i--) {
        View child = getChildAt(i);
        if (!&lt;em class="markup--em markup--pre-em"&gt;canViewReceivePointerEvents&lt;/em&gt;(child) ||
            !isTransformedTouchPointInView(x, y, child, null)) {
            continue;
        }&lt;em class="markup--em markup--pre-em"&gt;        
        //Set the right position for the touch, related to child position, and let it handle the touch event.&lt;/em&gt;
        dispatchTransformedTouchEvent(ev, false, child);
    }
    return true;
}
</code></pre>

<p>As you can guess, this code and the helper methods are brutally copied, with some simplifications, from ViewGroup source code (WHY doesn’t it protected dear android devs?!).</p>

<p>And the result:</p>

<p><img src="https://d262ilb51hltx0.cloudfront.net/max/800/1*hkSUnobyZD3cC01mGTzh7w.gif" alt="" /></p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	<a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- Post ad -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5508892730714185"
     data-ad-slot="8917228557"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<script type="text/javascript">
    google_ad_client = "ca-pub-5508892730714185";
    google_ad_slot = "8498426156";
    google_ad_width = 728;
    google_ad_height = 90;
</script>
<!-- Test add -->
<script type="text/javascript"
src="//pagead2.googlesyndication.com/pagead/show_ads.js">
</script>


<section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    Shem Magnezi


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
		</div>
	</div>
	

<script type="text/javascript">
      var disqus_shortname = 'shemblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://shem8.github.io/blog/2015/07/10/dont-touch-my-child-view/';
        var disqus_url = 'http://shem8.github.io/blog/2015/07/10/dont-touch-my-child-view/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
